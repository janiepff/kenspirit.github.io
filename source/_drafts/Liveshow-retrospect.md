title: 一块听听开发回顾
tags:
---

## 产品定位

一块听听性质和知乎 Live 是差不多的，属于语音直播，又主讲人单向发送语音消息，听众只能文字提问。为了能够快速开发上线，并让主讲人和听众容易参与，分享和传播。所以，我们一开始就决定不做原生的 App，直接选择把听众收听部分做 H5 页面，利用微信直接登录。对于听众来说，他只要从微信打开这个页面，就可以浏览所有的直播，购买和进入收听直播。  

由于做页面交互是非常耗时间和容易出 bug 的，所以我们尽量精简我们的前端功能。前端我们只有 4 个主页面：

1. 直播列表
2. 直播详情
3. 门票详情和购买
4. 直播收听

这里只有直播收听页面有听众的互动功能，其它页面都只是展示性质。直播收听页面里的互动功能，我们一开始也只做最基本的，也就是播放和暂停语音，提问和打赏。除了这几个互动功能外，当然还必须有实时接收主讲人语音和其它听众提问、打赏信息的能力。  

## 系统和架构设计

功能基本确定后，我们来看一看架构设计是怎么跟进的。  

针对于要尽量精简功能，快速上线系统，并让系统尽可能承载更多同时在线人数的目标，我们的理念是尽量把服务的压力转移到专门的服务提供商来负责。  

### 主讲人直播

前面只说到听众部分的 H5 页面，那么主讲人怎么直播？为了减少前端页面和工作量，我们决定让主讲人对着我们的微信公众号来直播。这样我们就能够直接利用微信本身就自带的语音录制，文字，图片上传等原生功能来实现主讲人直播的功能。这个选择当然也有不好的地方，就是主讲人没法很容易知道当前直播的状态，因为直播在微信公众号，听众在独立的 H5 页面。但是，为了节省一些开发资源，我们最后还是选择先这么做了。后期可能再改用小程序实现。  

但是主讲人怎么回答听众的提问呢？当主讲人每发一条消息到公众号，我们就会把当前直播室的状况，如在线人数，提问个数，打赏金额等自动回复给主讲人，同时带上一个 H5 页面的链接，里面会罗列所有的提问以备回答。  

因为我们没法利用微信公众号来让主讲人通过一种比较好的交互来回复问题，所以还是只能做一个 H5 页面。我们曾经考虑用 H5 的音频录音功能来实现，但是发现浏览器兼容性还是不太好。所以目前是利用微信的 JS SDK 来录音。  

### 听众听直播

根据我们当前的功能，和本身语音直播系统的特点，主要的系统压力有两个：  

1. 因为我们有限量提问票的区分，所以有可能有抢票（类秒杀）方面的压力

2. 直播开始时间，瞬时进入直播和维持同时在线人数的 socket 的压力

#### 提问票的模型设计

虽然我们的限量提问票的秒杀并不能和淘宝等电商类的量相比，但是其实原理也是一样。怎么样避免有限的资源不被重复


#### 消息缓存设计


## 技术坑

主讲人自动回复

主讲人消息处理慢，导致微信回复公众号没有响应问题

跨号支付

前端听众提问实现改版



不必做，但是耗费开发和测试精力的地方：

 - 讨论更改：即将结束，已经结束
 - 在线人数
 - 主讲人直播时回复逻辑
 - 更多直播，随机逻辑，直播排序问题


Oct 13 真正集成上微信才完成语音信息处理逻辑
Oct 20 前端做了主讲人回复消息功能
Oct 24 转上 production 环境
Nov 1  开始压测


